steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-t',
        '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE}:$COMMIT_SHA',
        '.'
      ]

  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'push',
        '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE}:$COMMIT_SHA'
      ]

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -ceu
      - |
        IMAGE_URI="${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE}:$COMMIT_SHA"

        deploy_args=(
          run deploy "${_SERVICE}"
          --image "$${IMAGE_URI}"
          --region "${_REGION}"
          --platform managed
          --allow-unauthenticated
        )

        if [[ -n "${_ADMIN_USERNAME_SECRET}" && -n "${_ADMIN_PASSWORD_SECRET}" ]]; then
          deploy_args+=(
            --set-secrets
            "ADMIN_USERNAME=${_ADMIN_USERNAME_SECRET}:latest,ADMIN_PASSWORD=${_ADMIN_PASSWORD_SECRET}:latest"
          )
          echo "Deploying with Secret Manager admin credentials."
        else
          echo "Deploying without Secret Manager substitutions."
        fi

        if [[ -n "${_DBURL}" ]]; then
          deploy_args+=(
            --set-secrets
            "DATABASE_URL=${_DBURL}:latest"
          )
          echo "Deploying with Secret Manager database URL."
        fi

        gcloud "$${deploy_args[@]}"

substitutions:
  _REGION: europe-north1
  _REPOSITORY: rs3-tracker
  _IMAGE: rs3-tracker
  _SERVICE: rs3-tracker
  _ADMIN_USERNAME_SECRET: 'rs3-admin-username'
  _ADMIN_PASSWORD_SECRET: 'rs3-admin-password'
  _DBURL: 'rs3-tracker-dburl'

options:
  logging: CLOUD_LOGGING_ONLY

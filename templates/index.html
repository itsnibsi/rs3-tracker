<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.player_name if data else 'RS3 Tracker' }} - RS3 Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>RS3 Tracker</h1>
                <div class="text-muted">
                    Last updated: <span id="lastUpdated">{{ data.latest.timestamp if data else 'Never' }}</span>
                </div>
            </div>
            <div class="header-actions">
                <a href="/admin" class="tf-btn admin-link-btn">Admin</a>
                <button id="updateBtn" class="tf-btn">Update Now</button>
            </div>
        </header>

        {% if data %}
        <div class="stats-grid">
            <div class="stat-card stat-card-wide">
                <div class="stat-title stat-title-main">{{ data.player_name }}</div>
                <div class="summary-metrics">
                    <div class="summary-metric">
                        <div class="summary-label">Total XP</div>
                        <div class="summary-value">{{ data.latest.total_xp_display }}</div>
                    </div>
                    <div class="summary-metric">
                        <div class="summary-label">Total Level</div>
                        <div class="summary-value">{{ "{:,}".format(data.latest.total_level) }}</div>
                    </div>
                    <div class="summary-metric">
                        <div class="summary-label">Overall Rank</div>
                        <div class="summary-value">{{ "{:,}".format(data.latest.overall_rank) }}</div>
                    </div>
                    <div class="summary-metric">
                        <div class="summary-label">Combat</div>
                        <div class="summary-value">{{ data.latest.combat_level }}</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Today's Biggest Gainers</div>
                {% if data.top_gainers_today %}
                <div class="active-skills-list">
                    {% for s in data.top_gainers_today %}
                    <div class="active-skill-row">
                        <span>{{ loop.index }}. {{ s.skill }}</span>
                        <span class="xp-gain-positive">+{{ s.xp_gain_display }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="summary-label active-skills-empty">No gains today</div>
                {% endif %}
            </div>
            <div class="stat-card">
                <div class="stat-title">Today Highlights</div>
                <div class="active-skills-list">
                    <div class="active-skill-row">
                        <span>XP Gained Today</span>
                        <span class="xp-gain-positive">+{{ data.today_highlights.xp_today_display }}</span>
                    </div>
                    <div class="active-skill-row">
                        <span>Levels Gained</span>
                        <span class="{{ 'xp-gain-positive' if data.today_highlights.levels_gained_today > 0 else '' }}">
                            {{ '+' if data.today_highlights.levels_gained_today > 0 else '' }}{{
                            "{:,}".format(data.today_highlights.levels_gained_today) }}
                        </span>
                    </div>
                    <div class="active-skill-row">
                        <span>Quests Finished</span>
                        <span
                            class="{{ 'xp-gain-positive' if data.today_highlights.quests_finished_today > 0 else '' }}">
                            {{ '+' if data.today_highlights.quests_finished_today > 0 else '' }}{{
                            "{:,}".format(data.today_highlights.quests_finished_today) }}
                        </span>
                    </div>
                    <div class="active-skill-row">
                        <span>Rank Change</span>
                        <span class="{{ data.today_highlights.rank_delta_today_class }}">
                            {{ data.today_highlights.rank_delta_today_display }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-column">
                <div class="panel tab-panel">
                    <div class="tab-header">
                        <div class="tab-buttons">
                            <button class="tf-btn tab-btn active" data-tab="skills">Skills</button>
                            <button class="tf-btn tab-btn" data-tab="feed">Activity Feed</button>
                        </div>
                    </div>

                    <div class="tab-content active" data-tab-content="skills">
                        <div class="skills-grid">
                            {% for s in data.skills %}
                            <div class="skill-card" data-skill="{{ s.skill }}" style="--skill-color: {{ s.color }};">
                                <div class="skill-header">
                                    <span class="skill-name">{{ s.skill }}</span>
                                    <span class="skill-level">{{ s.level }}</span>
                                </div>
                                <div class="skill-details">
                                    <span>{{ s.xp_display }} XP</span>
                                    {% if s.xp_gain > 0 %}
                                    <span class="xp-gain-positive">Today +{{ s.xp_gain_display }}</span>
                                    {% endif %}
                                </div>
                                <div class="progress-bg">
                                    <div class="progress-fill" style="width: {{ s.progress * 100 }}%"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-content" data-tab-content="feed">
                        <div class="feed-layout">
                            <aside class="feed-rail">
                                <div id="feedRailNav"></div>
                            </aside>
                            <div class="feed-stream" id="feedStream"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side-panel">
                <div class="panel panel-chart">
                    <h2>Total XP (30 Days)</h2>
                    <canvas id="totalXpChart" height="200"></canvas>
                </div>
                <div class="panel">
                    <h2>Closest Level-Ups</h2>
                    {% if data.closest_levels %}
                    <div class="nearest-level-list">
                        {% for s in data.closest_levels %}
                        <div class="nearest-level-row">
                            <div>
                                <div class="nearest-level-skill">{{ loop.index }}. {{ s.skill }}</div>
                                <div class="summary-label">To level {{ s.target_level }}</div>
                            </div>
                            <div class="nearest-level-xp">{{ s.xp_to_next_display }} XP</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="summary-label active-skills-empty">All tracked skills are maxed</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="panel">
            <p>No data collected yet. Click "Update Now" to run the collector.</p>
        </div>
        {% endif %}
    </div>

    <!-- Skill History Modal -->
    <div class="modal-overlay" id="skillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalSkillTitle">Skill History</h2>
                <button class="close-btn" id="closeModal" aria-label="Close">&times;</button>
            </div>
            <div id="skillGainSummary" class="skill-gain-summary"></div>
            <canvas id="skillChart" height="100"></canvas>
            <div id="skillNoGainsMessage" style="display:none; color: var(--text-muted); margin-top: 12px;">
                No gains in the selected range yet.
            </div>
            <div class="chart-controls">
                <button class="tf-btn active" data-period="day">1 day</button>
                <button class="tf-btn" data-period="week">1 week</button>
                <button class="tf-btn" data-period="month">1 month</button>
                <button class="tf-btn" data-period="year">1 year</button>
                <button class="tf-btn" data-period="all">all</button>
            </div>
        </div>
    </div>

    <script src="/static/js/feed.js"></script>
    <script src="/static/js/charts.js"></script>
    <script>
        // Format last-updated timestamp to local time
        const lu = document.getElementById('lastUpdated');
        if (lu && lu.textContent !== 'Never') {
            lu.textContent = new Date(lu.textContent).toLocaleString();
        }

        // Update button — show error state on failure instead of silent hang
        document.getElementById('updateBtn').addEventListener('click', async (e) => {
            e.target.disabled = true;
            e.target.textContent = 'Updating…';
            try {
                const res = await fetch('/api/update', { method: 'POST' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                location.reload();
            } catch (err) {
                e.target.textContent = 'Update Failed';
                e.target.disabled = false;
                setTimeout(() => { e.target.textContent = 'Update Now'; }, 3000);
            }
        });

        // Tab switching — triggers feed load on first activation
        function activateTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.dataset.tabContent === tab));
            if (tab === 'feed') loadAndRenderFeed();
        }
        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));
        activateTab('skills');

        {% if data %}
        initTotalXpChart({{ data.timestamps | tojson }}, {{ data.xp_history | tojson }});
        initSkillModal();
        {% endif %}
    </script>
</body>

</html>
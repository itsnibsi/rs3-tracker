<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.player_name if data else 'RS3 Tracker' }} - RS3 Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>{{ data.player_name if data else 'RS3 Tracker' }}</h1>
                <div style="color: var(--text-muted)">
                    Last updated: <span id="lastUpdated">{{ data.latest.timestamp if data else 'Never' }}</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/admin" class="tf-btn admin-link-btn">Admin</a>
                <button id="updateBtn" class="tf-btn">Update Now</button>
            </div>
        </header>

        {% if data %}
        <div class="stats-grid">
            <div class="stat-card stat-card-wide">
                <div class="stat-title">Account Summary</div>
                <div class="stat-value">{{ data.latest.total_xp_display }} XP</div>
                <div class="summary-row">
                    <div class="summary-cell">
                        <div class="summary-label">Total Level</div>
                        <div class="summary-value">{{ "{:,}".format(data.latest.total_level) }}</div>
                    </div>
                    <div class="summary-cell">
                        <div class="summary-label">Overall Rank</div>
                        <div class="summary-value">{{ "{:,}".format(data.latest.overall_rank) }}</div>
                    </div>
                    <div class="summary-cell">
                        <div class="summary-label">Combat</div>
                        <div class="summary-value">{{ data.latest.combat_level }}</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Today's Biggest Gainers</div>
                {% if data.top_gainers_today %}
                <div class="active-skills-list">
                    {% for s in data.top_gainers_today %}
                    <div class="active-skill-row">
                        <span>{{ loop.index }}. {{ s.skill }}</span>
                        <span class="xp-gain-positive">+{{ s.xp_gain_display }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="summary-label active-skills-empty">No gains today</div>
                {% endif %}
            </div>
            <div class="stat-card closest-level-card">
                <div class="stat-title">Closest Level-Ups</div>
                {% if data.closest_levels %}
                <div class="nearest-level-list">
                    {% for s in data.closest_levels %}
                    <div class="nearest-level-row">
                        <div>
                            <div class="nearest-level-skill">{{ loop.index }}. {{ s.skill }}</div>
                            <div class="summary-label">To level {{ s.target_level }}</div>
                        </div>
                        <div class="nearest-level-xp">{{ s.xp_to_next_display }} XP</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="summary-label active-skills-empty">All tracked skills are maxed</div>
                {% endif %}
            </div>
        </div>

        <div class="main-content">
            <div class="left-column">
                <div class="panel tab-panel">
                    <div class="tab-header">
                        <div class="tab-buttons">
                            <button class="tf-btn tab-btn active" data-tab="skills">Skills</button>
                            <button class="tf-btn tab-btn" data-tab="feed">Activity Feed</button>
                        </div>
                    </div>

                    <div class="tab-content active" data-tab-content="skills">
                        <div class="skills-grid">
                            {% for s in data.skills %}
                            <div class="skill-card" data-skill="{{ s.skill }}" style="--skill-color: {{ s.color }};">
                                <div class="skill-header">
                                    <span class="skill-name">{{ s.skill }}</span>
                                    <span class="skill-level">{{ s.level }}</span>
                                </div>
                                <div class="skill-details">
                                    <span>{{ s.xp_display }} XP</span>
                                    {% if s.xp_gain > 0 %}
                                    <span class="xp-gain-positive">Today +{{ s.xp_gain_display }}</span>
                                    {% endif %}
                                </div>
                                <div class="progress-bg">
                                    <div class="progress-fill" style="width: {{ s.progress * 100 }}%"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-content" data-tab-content="feed">
                        <div class="feed-layout">
                            <aside class="feed-rail">
                                <div id="feedRailNav"></div>
                            </aside>
                            <div class="feed-stream" id="feedStream"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side-panel">
                <div class="panel" style="margin-bottom: 24px;">
                    <h2>Total XP (30 Days)</h2>
                    <canvas id="totalXpChart" height="200"></canvas>
                </div>
            </div>
        </div>
        {% else %}
        <div class="panel">
            <p>No data collected yet. Click "Update Now" to run the collector.</p>
        </div>
        {% endif %}
    </div>

    <!-- Skill History Modal -->
    <div class="modal-overlay" id="skillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalSkillTitle">Skill History</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="skillGainSummary" class="skill-gain-summary"></div>
            <canvas id="skillChart" height="100"></canvas>
            <div id="skillNoGainsMessage" style="display:none; color: var(--text-muted); margin-top: 12px;">
                No gains in the selected range yet.
            </div>
            <div class="chart-controls">
                <button class="tf-btn active" data-period="day">1 day</button>
                <button class="tf-btn" data-period="week">1 week</button>
                <button class="tf-btn" data-period="month">1 month</button>
                <button class="tf-btn" data-period="year">1 year</button>
                <button class="tf-btn" data-period="all">all</button>
            </div>
        </div>
    </div>

    <script>
        const numberFmt = new Intl.NumberFormat();
        const cssVars = getComputedStyle(document.documentElement);
        const chartAccent = cssVars.getPropertyValue('--accent').trim() || '#8da0b6';
        const chartMuted = cssVars.getPropertyValue('--text-muted').trim() || '#9aa1ab';
        const chartGrid = cssVars.getPropertyValue('--border').trim() || '#31353c';
        const hexToRgba = (hex, alpha) => {
            if (!hex || !hex.startsWith('#')) return `rgba(141, 160, 182, ${alpha})`;
            const full = hex.length === 4
                ? `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}`
                : hex;
            const int = parseInt(full.slice(1), 16);
            const r = (int >> 16) & 255;
            const g = (int >> 8) & 255;
            const b = int & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };
        const formatXpNumber = (value) =>
            value == null || Number.isNaN(Number(value)) ? '-' : numberFmt.format(Math.round(Number(value)));
        const previousNonNull = (series, index) => {
            for (let i = index - 1; i >= 0; i--) {
                if (series[i] != null) return Number(series[i]);
            }
            return null;
        };
        const formatDelta = (current, previous) => {
            if (current == null || previous == null) return 'n/a';
            const delta = Number(current) - Number(previous);
            const sign = delta > 0 ? '+' : '';
            return `${sign}${numberFmt.format(Math.round(delta))}`;
        };
        // Format Local Time
        const lu = document.getElementById('lastUpdated');
        if (lu && lu.textContent !== 'Never') {
            lu.textContent = new Date(lu.textContent).toLocaleString();
        }

        // Manual Update Button
        document.getElementById('updateBtn').addEventListener('click', async (e) => {
            e.target.disabled = true; e.target.textContent = 'Updating...';
            await fetch('/api/update', { method: 'POST' });
            location.reload();
        });

        {% if data %}
        const activitiesData = {{ data.activities | tojson }};

        function formatFeedDayLabel(dayDate, now) {
            const dayStart = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
            const nowStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const diffDays = Math.round((nowStart - dayStart) / 86400000);
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            return dayDate.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        }

        function groupActivitiesByDay(items) {
            const groups = new Map();
            items.forEach((activity) => {
                const dt = activity.date_iso ? new Date(activity.date_iso) : null;
                if (dt && !Number.isNaN(dt.valueOf())) {
                    const key = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}`;
                    if (!groups.has(key)) groups.set(key, { dt, items: [] });
                    groups.get(key).items.push(activity);
                    return;
                }
                if (!groups.has('Unknown')) groups.set('Unknown', { dt: null, items: [] });
                groups.get('Unknown').items.push(activity);
            });
            return [...groups.entries()].map(([key, value], idx) => ({
                key,
                id: `feed-day-${key.replace(/[^0-9A-Za-z_-]/g, '-') || (idx + 1)}`,
                dt: value.dt,
                items: value.items
            }));
        }

        function renderActivityFeed(items) {
            const rail = document.getElementById('feedRailNav');
            const stream = document.getElementById('feedStream');
            if (!rail || !stream) return;

            rail.innerHTML = '';
            stream.innerHTML = '';

            const groups = groupActivitiesByDay(items);
            const now = new Date();
            const typeCounts = new Map();

            if (!groups.length) {
                const empty = document.createElement('div');
                empty.className = 'summary-label';
                empty.textContent = 'No activities yet.';
                stream.appendChild(empty);
                return;
            }

            groups.forEach((group) => {
                const railBtn = document.createElement('a');
                railBtn.href = `#${group.id}`;
                railBtn.className = 'feed-rail-link';
                railBtn.textContent = group.dt ? formatFeedDayLabel(group.dt, now) : 'Unknown Date';
                rail.appendChild(railBtn);

                const section = document.createElement('section');
                section.className = 'feed-day-group';
                section.id = group.id;

                const dayTitle = document.createElement('h3');
                dayTitle.className = 'feed-day-title';
                dayTitle.textContent = group.dt ? formatFeedDayLabel(group.dt, now) : 'Unknown Date';
                section.appendChild(dayTitle);

                const cardFlow = document.createElement('div');
                cardFlow.className = 'feed-card-flow';

                group.items.forEach((activity) => {
                    const card = document.createElement('article');
                    card.className = `feed-card feed-type-${activity.type_key || 'activity'}`;
                    if (activity.id != null) card.id = `feed-activity-${activity.id}`;
                    if (activity.color) card.style.setProperty('--card-accent', activity.color);

                    const rail = document.createElement('div');
                    rail.className = 'feed-card-rail';
                    const iconPath = activity.skill
                        ? `/static/skills_64/${activity.skill.toLowerCase()}.png`
                        : `/static/icons_64/${activity.type_key || 'activity'}.png`;
                    rail.style.setProperty('--card-icon-url', `url("${iconPath}")`);

                    const body = document.createElement('div');
                    body.className = 'feed-card-body';
                    const title = document.createElement('h4');
                    title.className = 'feed-card-title';
                    title.textContent = activity.details ?? activity.text;

                    const date = document.createElement('div');
                    date.className = 'feed-card-date';
                    if (activity.date_iso) {
                        const dt = new Date(activity.date_iso);
                        date.textContent = Number.isNaN(dt.valueOf())
                            ? activity.date
                            : dt.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                    } else {
                        date.textContent = activity.date || '';
                    }

                    body.appendChild(title);
                    body.appendChild(date);
                    card.appendChild(rail);
                    card.appendChild(body);
                    cardFlow.appendChild(card);

                    const typeLabel = activity.type_label || 'Activity';
                    typeCounts.set(typeLabel, (typeCounts.get(typeLabel) || 0) + 1);
                });

                section.appendChild(cardFlow);
                stream.appendChild(section);
            });

            [...typeCounts.entries()]
                .sort((a, b) => b[1] - a[1])
                .forEach(([label, count]) => {
                    const row = document.createElement('div');
                    row.className = 'active-skill-row';
                    const l = document.createElement('span');
                    l.textContent = label;
                    const c = document.createElement('span');
                    c.textContent = numberFmt.format(count);
                    row.appendChild(l);
                    row.appendChild(c);
                });
        }

        function readTabFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab === 'feed' || tab === 'skills') return tab;
            return null;
        }

        function writeTabToUrl(tab) {
            const url = new URL(window.location.href);
            url.searchParams.set('tab', tab);
            window.history.replaceState(null, '', `${url.pathname}?${url.searchParams.toString()}${url.hash}`);
        }

        function activateTab(tab, updateUrl = true) {
            document.querySelectorAll('.tab-btn').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach((content) => {
                content.classList.toggle('active', content.dataset.tabContent === tab);
            });
            if (updateUrl) writeTabToUrl(tab);
        }

        document.querySelectorAll('.tab-btn').forEach((btn) => {
            btn.addEventListener('click', () => activateTab(btn.dataset.tab, true));
        });

        renderActivityFeed(activitiesData);

        const hash = window.location.hash || '';
        const hashTargetsFeed = hash.startsWith('#feed-day-') || hash.startsWith('#feed-activity-');
        const initialTab = hashTargetsFeed ? 'feed' : (readTabFromUrl() || 'skills');
        activateTab(initialTab, false);

        window.addEventListener('hashchange', () => {
            const h = window.location.hash || '';
            if (h.startsWith('#feed-day-') || h.startsWith('#feed-activity-')) {
                activateTab('feed', true);
            }
        });

        // Static total XP chart (30 days)
        new Chart(document.getElementById('totalXpChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ data.timestamps | tojson }},
            datasets: [{
                label: 'Total XP', data: {{ data.xp_history | tojson }},
            borderColor: chartAccent, backgroundColor: hexToRgba(chartAccent, 0.15),
            borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0
                }]
            },
            options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `Total XP: ${formatXpNumber(ctx.parsed.y)}`,
                        afterLabel: (ctx) => {
                            const prev = previousNonNull(ctx.dataset.data, ctx.dataIndex);
                            return `Delta: ${formatDelta(ctx.parsed.y, prev)}`;
                        }
                    }
                }
            },
            scales: {
                x: { type: 'time', time: { tooltipFormat: 'll HH:mm' }, ticks: { color: chartMuted }, grid: { color: chartGrid } },
                y: { ticks: { color: chartMuted, callback: val => val.toLocaleString() }, grid: { color: chartGrid } }
            }
        }
        });

        // Skill modal chart
        const modal = document.getElementById('skillModal');
        const modalContent = modal.querySelector('.modal-content');
        const noGains = document.getElementById('skillNoGainsMessage');
        const gainSummary = document.getElementById('skillGainSummary');
        let currentSkill = '';
        let currentSkillColor = chartAccent;
        let skillChartInstance = null;
        const periodLabel = (period) => {
            if (period === 'day') return 'past day';
            if (period === 'week') return 'past week';
            if (period === 'month') return 'current month';
            if (period === 'year') return 'past year';
            return 'selected range';
        };
        const calculateRangeGain = (series) => {
            const values = (series || []).filter(v => v != null).map(Number);
            if (!values.length) return null;
            return Math.max(0, values[values.length - 1] - values[0]);
        };

        document.querySelectorAll('.skill-card').forEach(card => {
            card.addEventListener('click', () => {
                currentSkill = card.dataset.skill;
                currentSkillColor = getComputedStyle(card).getPropertyValue('--skill-color').trim() || chartAccent;
                modalContent.style.setProperty('--modal-accent', currentSkillColor);
                document.getElementById('modalSkillTitle').textContent = `${currentSkill} History`;
                modal.classList.add('active');

                document.querySelectorAll('#skillModal .chart-controls .tf-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('#skillModal .chart-controls .tf-btn[data-period="day"]').classList.add('active');
                loadSkillData(currentSkill, 'day');
            });
        });

        document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

        document.querySelectorAll('#skillModal .chart-controls .tf-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('#skillModal .chart-controls .tf-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                loadSkillData(currentSkill, e.target.dataset.period);
            });
        });

        async function loadSkillData(skill, period) {
            const res = await fetch(`/api/chart/${encodeURIComponent(skill)}/${period}`);
            const chartData = await res.json();
            const totalGain = calculateRangeGain(chartData.totals);
            const range = periodLabel(period);

            if (skillChartInstance) {
                skillChartInstance.destroy();
                skillChartInstance = null;
            }

            if (!chartData.has_gains) {
                noGains.style.display = 'block';
                gainSummary.textContent = `Gained in ${range}: n/a`;
                return;
            }

            noGains.style.display = 'none';
            gainSummary.textContent = `Gained in ${range}: ${formatXpNumber(totalGain)} XP`;
            const timeUnit = period === 'day' ? 'hour' : 'day';
            const tooltipFormat = period === 'day' ? 'll HH:mm' : 'll';
            const pointRadius = chartData.labels.length > 180 ? 0 : (chartData.labels.length > 60 ? 1.5 : 3);

            skillChartInstance = new Chart(document.getElementById('skillChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: `${skill} XP`,
                        data: chartData.totals,
                        borderColor: currentSkillColor,
                        backgroundColor: hexToRgba(currentSkillColor, 0.15),
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: pointRadius
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatXpNumber(ctx.parsed.y)}`,
                                afterLabel: (ctx) => {
                                    const prev = previousNonNull(ctx.dataset.data, ctx.dataIndex);
                                    return `Delta: ${formatDelta(ctx.parsed.y, prev)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: timeUnit,
                                tooltipFormat: tooltipFormat,
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MMM D'
                                }
                            },
                            ticks: { color: chartMuted },
                            grid: { color: chartGrid }
                        },
                        y: { ticks: { color: chartMuted, callback: val => val.toLocaleString() }, grid: { color: chartGrid } }
                    }
                }
            });
        }
        {% endif %}
    </script>
</body>

</html>
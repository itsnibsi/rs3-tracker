<!DOCTYPE html>
<html>

<head>
    <title>Skills</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <h1>Skills</h1>
        <table id="skills-table">
            <tr>
                <th>Skill</th>
                <th>Level</th>
                <th>Total XP</th>
                <th>XP (24h)</th>
                <th>Rank</th>
            </tr>
            {% for s in skills %}
            <tr class="skill-row" data-skill="{{ s.skill }}">
                <td>{{ s.skill }}</td>
                <td>{{ s.level }}</td>
                <td>{{ s.xp }}</td>
                <td>{{ s.xp_gain }}</td>
                <td>{{ s.rank }}</td>
            </tr>
            <tr class="skill-chart-row" style="display:none;">
                <td colspan="5">
                    <canvas class="skill-chart" width="800" height="200"></canvas>
                    <div>
                        Timeframe:
                        <button class="tf-btn" data-timeframe="hour">Hour</button>
                        <button class="tf-btn" data-timeframe="day">Day</button>
                        <button class="tf-btn" data-timeframe="week">Week</button>
                        <button class="tf-btn" data-timeframe="month">Month</button>
                        <button class="tf-btn" data-timeframe="year">Year</button>
                        <button class="tf-btn" data-timeframe="all">All</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
        <a href="/">Back</a>
    </div>

    <script>
        document.querySelectorAll('.skill-row').forEach(row => {
            row.addEventListener('click', async () => {
                const nextRow = row.nextElementSibling;
                const canvas = nextRow.querySelector('canvas');
                const skill = row.dataset.skill;

                // Toggle display
                if (nextRow.style.display === 'none') {
                    nextRow.style.display = '';

                    // Fetch skill history (default 'all')
                    const data = await fetch(`/skill_history/${skill}?timeframe=all`).then(r => r.json());
                    const labels = data.map(d => d.timestamp);
                    const xp = data.map(d => d.xp);

                    // Create chart
                    if (canvas.chart) canvas.chart.destroy();
                    canvas.chart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: { labels: labels, datasets: [{ label: skill + ' XP', data: xp, borderWidth: 2 }] },
                        options: { responsive: true }
                    });
                } else {
                    nextRow.style.display = 'none';
                }
            });
        });

        // Timeframe buttons
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const tr = e.target.closest('tr').previousElementSibling; // skill row
                const skill = tr.dataset.skill;
                const canvas = tr.nextElementSibling.querySelector('canvas');
                const timeframe = e.target.dataset.timeframe;

                const data = await fetch(`/skill_history/${skill}?timeframe=${timeframe}`).then(r => r.json());
                const labels = data.map(d => d.timestamp);
                const xp = data.map(d => d.xp);

                if (canvas.chart) canvas.chart.destroy();
                canvas.chart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: skill + ' XP', data: xp, borderWidth: 2 }] },
                    options: { responsive: true }
                });
            });
        });
    </script>
</body>

</html>